# SES 設定・レート制御

## SES アカウント設定

### サンドボックス解除

本番利用には必須。デフォルトのサンドボックスモードでは以下の制限がある:
- 送信レート: 1通/秒
- 日次送信数: 200通/日
- 送信先: 検証済みアドレスのみ

### 送信レート上限申請

- 200通/秒 以上を推奨
- AWS コンソールの SES > Account dashboard > Request production access から申請
- 承認まで通常 24時間程度

### 送信クォータ

- 日次上限が 200,000通 以上であることを確認
- クォータは実績に応じて自動的に引き上げられるが、初期値が不足する場合は手動で上限引き上げを申請

---

## 送信レート制御の仕組み

SQS → Lambda の MaximumConcurrency でレートを制御する。

```
SES送信レート: 200通/秒 の場合

SQS → Lambda:
  MaximumConcurrency = 4
  各Lambda = 1メッセージ（50宛先）を処理
  各Lambda処理時間 ≈ 1秒

  → 4並列 × 50通 = 200通/秒（SES上限に一致）

200,000通 ÷ 200通/秒 = 1,000秒 ≈ 約17分で完了
```

### MaximumConcurrency の調整

| SES送信レート | MaximumConcurrency | 1メッセージあたりの宛先数 | 理論スループット | 20万件の完了時間 |
|---|---|---|---|---|
| 50通/秒 | 1 | 50 | 50通/秒 | 約67分 |
| 100通/秒 | 2 | 50 | 100通/秒 | 約33分 |
| 200通/秒 | 4 | 50 | 200通/秒 | 約17分 |
| 500通/秒 | 10 | 50 | 500通/秒 | 約7分 |

- `MaximumConcurrency` の値を調整することでレートを制御
- SES スロットリングが発生した場合、SQS が自動リトライ（visibility timeout 経過後）

---

## SES ドメイン認証設定

送信前に以下の設定が必要:

### 1. ドメイン認証

送信元ドメインを SES に登録し、所有権を証明する。

### 2. DKIM 設定

Route 53 に DKIM レコード（CNAME × 3）を追加。
メールの送信元が正当であることを受信サーバーが検証できる。

### 3. SPF 設定

Route 53 に SPF レコードを追加。
送信元IPアドレスが正規のものであることを証明する。

### 4. DMARC 設定

なりすまし防止ポリシーを設定。
DKIM と SPF の検証結果に基づいて受信サーバーの挙動を制御する。

### 5. カスタム MAIL FROM ドメイン

バウンス通知の返送先ドメインを設定。
SES デフォルトの MAIL FROM ではなく自ドメインを使用することで、送信元の信頼性を向上させる。
