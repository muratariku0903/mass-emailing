# ITテストケース

## テストカテゴリ一覧

| カテゴリ | テスト数 | 対象フロー |
|---|---|---|
| [A. 新規登録](#a-新規登録) | 14 | 登録フロー全体 |
| [B. 編集](#b-編集) | 16 | パターンA・パターンB |
| [C. 送信](#c-送信) | 18 | 送信WF・SQS・Lambda・SES |
| [D. 失敗・リカバリ](#d-失敗リカバリ) | 14 | DLQ・エラー処理・リトライ |
| [E. 複数キャンペーン同時実行](#e-複数キャンペーン同時実行) | 6 | SESレート制御・共通キュー |
| [F. バウンス・苦情処理](#f-バウンス苦情処理) | 10 | SESイベント・suppression_list |
| [G. CSVバリデーション](#g-csvバリデーション) | 10 | CSV取込時の検証 |
| [H. 排他制御](#h-排他制御) | 6 | 楽観的ロック・ステータス排他 |
| [I. パフォーマンス・負荷](#i-パフォーマンス負荷) | 8 | 大量データ・RDS接続・スループット |

---

## A. 新規登録

### A-01: Presigned URL取得 — 正常系

| 項目 | 内容 |
|---|---|
| 前提条件 | スタッフが認証済み |
| 操作 | `GET /presigned-url` を呼び出す |
| 期待結果 | `s3_key`（`uploads/{uuid}.csv` 形式）と `presigned_url` が返却される。ステータスコード 200 |
| 確認項目 | - s3_key がUUID形式であること<br>- presigned_url がS3のPUT用URLであること<br>- 有効期限が15分に設定されていること |

### A-02: CSVアップロード — 正常系

| 項目 | 内容 |
|---|---|
| 前提条件 | A-01 で Presigned URL 取得済み |
| 操作 | Presigned URL を使って S3 に CSV を PUT（Content-Type: text/csv） |
| 期待結果 | S3 から HTTP 200 が返却される |
| 確認項目 | - S3 の該当パスにCSVファイルが保存されていること<br>- ファイル内容がアップロード元と一致すること |

### A-03: CSVアップロード — Presigned URL有効期限切れ

| 項目 | 内容 |
|---|---|
| 前提条件 | A-01 で取得した Presigned URL の有効期限（15分）が経過 |
| 操作 | 期限切れの Presigned URL で S3 に PUT |
| 期待結果 | S3 から HTTP 403 が返却される |
| 確認項目 | - フロントエンドがエラーを適切にハンドリングし、ユーザーに再取得を促すこと |

### A-04: キャンペーン登録API — 正常系

| 項目 | 内容 |
|---|---|
| 前提条件 | CSVが S3 にアップロード済み |
| 操作 | `POST /campaigns` を呼び出す（subject, body_html, body_text, from_address, scheduled_at, s3_key） |
| 期待結果 | `{ campaign_id }` が即時返却される。ステータスコード 201 |
| 確認項目 | - RDS に `notification_campaigns` レコードが作成されていること<br>- status = `取込中` であること<br>- Step Functions（CSV取込WF）が起動されていること |

### A-05: キャンペーン登録API — 必須パラメータ欠落

| 項目 | 内容 |
|---|---|
| 前提条件 | なし |
| 操作 | `POST /campaigns` を必須パラメータ不足で呼び出す（例: s3_key なし） |
| 期待結果 | ステータスコード 400（Bad Request）でバリデーションエラーメッセージが返却される |
| 確認項目 | - RDS にレコードが作成されていないこと<br>- Step Functions が起動されていないこと |

### A-06: CSV取込WF — 正常系（20万件）

| 項目 | 内容 |
|---|---|
| 前提条件 | A-04 でキャンペーン登録完了。CSVは20万件のメールアドレスを含む |
| 操作 | CSV取込WF が自動実行される |
| 期待結果 | WF が正常完了し、キャンペーンステータスが `送信予約済` に遷移する |
| 確認項目 | - State 0: 既存宛先が DELETE されること（初回登録では0件）<br>- State 1: CSV が 5,000件ごとに40チャンクに分割され、S3 に保存されること<br>- State 2: Map State（MaxConcurrency=5）で並列バッチINSERTされること<br>- State 3: `total_count` = 200,000、status = `送信予約済` に更新されること<br>- 送信WF が `startExecution` で起動されること<br>- `execution_arn` が RDS に保存されること<br>- 全体処理時間が約24〜33秒以内であること |

### A-07: CSV取込WF — 少数件（10件）

| 項目 | 内容 |
|---|---|
| 前提条件 | CSVが10件のメールアドレスを含む |
| 操作 | `POST /campaigns` → CSV取込WF実行 |
| 期待結果 | WF が正常完了。チャンク数は1。total_count = 10 |
| 確認項目 | - 少数件でもチャンク分割・Map State が正常動作すること<br>- status が `送信予約済` に遷移すること |

### A-08: CSV取込WF — CSVバリデーションエラー（人為的エラー）

| 項目 | 内容 |
|---|---|
| 前提条件 | 不正な形式のCSVファイル（例: ヘッダー行なし、不正なエンコーディング） |
| 操作 | `POST /campaigns` → CSV取込WF実行 |
| 期待結果 | State 1 で `CSVValidationError` が throw され、Catch で捕捉される |
| 確認項目 | - 全宛先が DELETE されること<br>- status = `取込失敗` に更新されること<br>- CloudWatch にエラーログが出力されること<br>- 送信WF は起動されないこと |

### A-09: CSV取込WF — Map State チャンク失敗（リトライ成功）

| 項目 | 内容 |
|---|---|
| 前提条件 | Map State の1チャンクで一時的なRDS接続エラーが発生（模擬） |
| 操作 | CSV取込WF 実行 |
| 期待結果 | Retry（MaxAttempts=2, BackoffRate=2.0）で自動リトライされ、成功する |
| 確認項目 | - リトライが実行されたことがStep Functionsの実行履歴で確認できること<br>- 最終的に status = `送信予約済` に遷移すること<br>- total_count が正しいこと |

### A-10: CSV取込WF — Map State 全リトライ失敗（システムエラー）

| 項目 | 内容 |
|---|---|
| 前提条件 | Map State の全リトライが失敗する状況（RDS持続的障害を模擬） |
| 操作 | CSV取込WF 実行 |
| 期待結果 | WFが異常終了する |
| 確認項目 | - status は `取込中` のまま変更されないこと<br>- CloudWatch で `取込中` 滞留アラームが発火すること（30分超過時） |

### A-11: CSV取込WF — 送信WF自動起動の確認

| 項目 | 内容 |
|---|---|
| 前提条件 | CSV取込WF の State 3 まで正常完了 |
| 操作 | なし（State 3 が自動で送信WF を起動） |
| 期待結果 | 送信WF が起動し、Wait 状態で `scheduled_at` まで待機する |
| 確認項目 | - Step Functions コンソールで送信WF が `RUNNING` 状態であること<br>- Wait の終了時刻が `scheduled_at` と一致すること<br>- `execution_arn` が正しくRDSに保存されていること |

### A-12: キャンペーン登録 — scheduled_at が過去日時

| 項目 | 内容 |
|---|---|
| 前提条件 | なし |
| 操作 | `POST /campaigns` で `scheduled_at` に過去日時を指定 |
| 期待結果 | API がバリデーションエラー（400）を返すか、送信WF の Wait が即座にスキップされ送信処理が開始される（仕様による） |
| 確認項目 | - 意図しない即時送信が発生しないこと、または即時送信として正しく動作すること |

### A-13: キャンペーン登録 — from_address がSES認証済みドメインと不一致

| 項目 | 内容 |
|---|---|
| 前提条件 | SES で認証されていないドメインの from_address を指定 |
| 操作 | `POST /campaigns` → CSV取込WF → 送信WF → メール送信 |
| 期待結果 | SES が `MAIL_FROM_DOMAIN_NOT_VERIFIED` エラーを返す |
| 確認項目 | - 宛先ステータスが `送信失敗` になること<br>- error_message にエラー内容が記録されること |

### A-14: Presigned URL取得 — 同時リクエスト

| 項目 | 内容 |
|---|---|
| 前提条件 | 複数スタッフが同時に Presigned URL を取得 |
| 操作 | `GET /presigned-url` を並行して複数回呼び出す |
| 期待結果 | それぞれ異なる `s3_key` が返却される |
| 確認項目 | - UUID が衝突しないこと<br>- 各 Presigned URL が独立して使用可能であること |

---

## B. 編集

### B-01: パターンA（メタデータ編集） — 件名変更（送信予約済）

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーンが存在 |
| 操作 | `PUT /campaigns/{id}`（s3_key なし、subject を変更） |
| 期待結果 | RDS の subject が更新される。ステータスコード 200 |
| 確認項目 | - status は `送信予約済` のまま変化しないこと<br>- 送信WF は中断されないこと（Wait 継続）<br>- 宛先データに変更がないこと |

### B-02: パターンA（メタデータ編集） — 送信日時変更（送信予約済）

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーンが存在。送信WF が Wait 中 |
| 操作 | `PUT /campaigns/{id}`（s3_key なし、scheduled_at を変更） |
| 期待結果 | 送信WF が停止→新しい scheduled_at で再起動される |
| 確認項目 | - 旧 execution_arn の WF が `ABORTED` になること<br>- 新しい WF が `RUNNING` で Wait 状態であること<br>- 新しい `execution_arn` が RDS に保存されること<br>- Wait 終了時刻が新しい `scheduled_at` と一致すること<br>- status は `送信予約済` のまま変化しないこと |

### B-03: パターンA（メタデータ編集） — 本文変更（送信予約済、日時変更なし）

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーンが存在 |
| 操作 | `PUT /campaigns/{id}`（s3_key なし、body_html と body_text を変更、scheduled_at は変更なし） |
| 期待結果 | RDS の body_html, body_text が更新される |
| 確認項目 | - 送信WF は停止されず Wait 継続すること<br>- 送信開始時に RDS から最新データを読み取るため、更新後の本文で送信されること |

### B-04: パターンA（メタデータ編集） — 取込失敗ステータスで編集

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `取込失敗` のキャンペーンが存在 |
| 操作 | `PUT /campaigns/{id}`（s3_key なし、subject を変更） |
| 期待結果 | RDS の subject が更新される |
| 確認項目 | - status は `取込失敗` のまま変化しないこと |

### B-05: パターンB（CSV差し替え） — 送信予約済から差し替え

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン（旧CSV 10万件）。送信WF が Wait 中 |
| 操作 | 1. `GET /presigned-url`<br>2. S3 に新CSV（15万件）をアップロード<br>3. `PUT /campaigns/{id}`（s3_key あり） |
| 期待結果 | 送信WF が停止 → status = `取込中` → CSV取込WF実行 → status = `送信予約済` → 送信WF再起動 |
| 確認項目 | - 旧送信WF が `ABORTED` になること<br>- 旧宛先（10万件）が全て DELETE されること<br>- 新宛先（15万件）が INSERT されること<br>- total_count = 150,000 に更新されること<br>- 新しい送信WF が起動し Wait 中であること<br>- 新しい `execution_arn` が RDS に保存されること |

### B-06: パターンB（CSV差し替え） — 取込失敗からの復旧

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `取込失敗` のキャンペーン（宛先は0件） |
| 操作 | 1. `GET /presigned-url`<br>2. S3 に新CSV（5万件）をアップロード<br>3. `PUT /campaigns/{id}`（s3_key あり） |
| 期待結果 | status = `取込中` → CSV取込WF実行 → status = `送信予約済` → 送信WF起動 |
| 確認項目 | - 宛先が0件の状態から正常に INSERT されること<br>- total_count = 50,000 に更新されること<br>- 送信WF が起動し Wait 中であること |

### B-07: パターンB（CSV差し替え） — 差し替え中にCSVバリデーションエラー

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン（旧CSV 10万件） |
| 操作 | 不正な新CSV で差し替え |
| 期待結果 | 旧宛先 DELETE → CSVバリデーションエラー → 全宛先 DELETE → status = `取込失敗` |
| 確認項目 | - **旧宛先データも失われること**（仕様通り）<br>- status = `取込失敗` であること<br>- notification_recipients が0件であること<br>- スタッフがCSV再アップロードで復旧できること |

### B-08: 編集不可ステータスでの編集拒否 — 取込中

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `取込中` のキャンペーン |
| 操作 | `PUT /campaigns/{id}` |
| 期待結果 | HTTP 409 Conflict が返却される |
| 確認項目 | - RDS のデータが変更されていないこと<br>- フロントエンドで編集ボタンが非活性であること |

### B-09: 編集不可ステータスでの編集拒否 — 送信中

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信中` のキャンペーン |
| 操作 | `PUT /campaigns/{id}` |
| 期待結果 | HTTP 409 Conflict が返却される |
| 確認項目 | - RDS のデータが変更されていないこと |

### B-10: 編集不可ステータスでの編集拒否 — 送信完了

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信完了` のキャンペーン |
| 操作 | `PUT /campaigns/{id}` |
| 期待結果 | HTTP 409 Conflict が返却される |

### B-11: 編集不可ステータスでの編集拒否 — 送信失敗

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信失敗` のキャンペーン |
| 操作 | `PUT /campaigns/{id}` |
| 期待結果 | HTTP 409 Conflict が返却される |

### B-12: パターンB — メタデータとCSVの同時変更

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン |
| 操作 | `PUT /campaigns/{id}`（s3_key あり + subject, body_html, scheduled_at も変更） |
| 期待結果 | メタデータ更新とCSV差し替えが同時に処理される |
| 確認項目 | - subject, body_html, scheduled_at が新しい値に更新されること<br>- 新CSV の宛先が INSERT されること<br>- 送信WF が新しい scheduled_at で起動すること |

### B-13: パターンA — scheduled_at を送信WF Wait 完了前ギリギリに変更

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済`、scheduled_at が5分後のキャンペーン |
| 操作 | scheduled_at を10分後に変更 |
| 期待結果 | 送信WF が停止→10分後で再起動される |
| 確認項目 | - 旧 WF の停止と新 WF の起動がレースコンディションなく処理されること |

### B-14: パターンA — scheduled_at を現在時刻より前に変更

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン |
| 操作 | `PUT /campaigns/{id}` で scheduled_at を過去日時に変更 |
| 期待結果 | バリデーションエラーで拒否されるか、即時送信として動作する（仕様確認要） |
| 確認項目 | - 意図しない動作が発生しないこと |

### B-15: Step Functions 冪等性確認

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン |
| 操作 | パターンB の CSV差し替えを短時間に2回連続実行 |
| 期待結果 | execution name に campaign_id が含まれ、重複起動が防止される |
| 確認項目 | - CSV取込WF が2重起動されないこと<br>- 2回目のリクエストが適切にハンドリングされること |

### B-16: パターンB — CSV差し替え中のシステムエラー

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン。CSV差し替え時にRDS障害を模擬 |
| 操作 | CSV差し替え実行 |
| 期待結果 | status = `取込中` のまま滞留 |
| 確認項目 | - ステータスが更新されないこと<br>- CloudWatch で検知されること |

---

## C. 送信

### C-01: 送信WF — Wait完了→送信開始（正常系）

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済`。scheduled_at が到達 |
| 操作 | 送信WF の Wait が完了し、State 1 に遷移 |
| 期待結果 | status が `送信予約済` → `送信中` に更新される |
| 確認項目 | - State 1 で status = `送信予約済` が確認されること<br>- status = `送信中` に正しく更新されること |

### C-02: 送信WF — State 1 でステータス不一致

| 項目 | 内容 |
|---|---|
| 前提条件 | Wait 完了後にキャンペーンの status が `送信予約済` 以外になっている（例: 編集操作で取込中に変わった） |
| 操作 | State 1 のバリデーション実行 |
| 期待結果 | エラー「不正なステータス」で WF が終了する |
| 確認項目 | - 送信処理が開始されないこと<br>- 適切なエラーログが出力されること |

### C-03: 送信WF — バッチ分割 & SQSエンキュー（20万件）

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件の宛先が登録済み。status = `送信中` |
| 操作 | State 2-3 が実行される |
| 期待結果 | 宛先が50件ずつのSQSメッセージに分割され、共通キューにエンキューされる |
| 確認項目 | - バッチ数が ceil(200,000 / 5,000) = 40 であること<br>- Map State（MaxConcurrency=5）で並列実行されること<br>- SQS メッセージ数が 200,000 / 50 = 4,000 であること<br>- 各メッセージに campaign_id と recipients（最大50件）が含まれること |

### C-04: メール送信Lambda — 正常系（50件一括送信）

| 項目 | 内容 |
|---|---|
| 前提条件 | SQS メッセージに50件の宛先が含まれる |
| 操作 | Lambda が SQS メッセージを処理 |
| 期待結果 | 50件全てが正常に送信される |
| 確認項目 | - 宛先 status: `未送信` → `送信中` → `送信済` と遷移すること<br>- SES SendBulkEmail が1回呼び出されること<br>- sent_at が記録されること<br>- ses_message_id が各宛先に保存されること |

### C-05: メール送信Lambda — RDS更新先行方式（重複送信防止）

| 項目 | 内容 |
|---|---|
| 前提条件 | SQS メッセージが再配信される状況を模擬（Lambda タイムアウト等） |
| 操作 | 同じ SQS メッセージが2回処理される |
| 期待結果 | 2回目の処理で `送信中` の宛先がスキップされる |
| 確認項目 | - 1回目: status = `未送信` → `送信中` に更新され、SES 呼び出し実行<br>- 2回目: status = `送信中` の宛先はスキップされ、SES 呼び出しが実行されないこと<br>- 重複送信が発生しないこと |

### C-06: メール送信Lambda — SES 部分失敗（一部 MESSAGE_REJECTED）

| 項目 | 内容 |
|---|---|
| 前提条件 | 50件中一部が MESSAGE_REJECTED になる状況 |
| 操作 | Lambda が SendBulkEmail を呼び出す |
| 期待結果 | 宛先ごとにステータスが振り分けられる |
| 確認項目 | - SUCCESS の宛先: status = `送信済`<br>- MESSAGE_REJECTED の宛先: status = `送信失敗`、error_message に Status 値が記録されること<br>- Lambda 自体はエラー終了しないこと（SQSリトライされないこと） |

### C-07: メール送信Lambda — SES API例外（50件全失敗）

| 項目 | 内容 |
|---|---|
| 前提条件 | SES が API リクエスト自体を拒否する状況（例: ACCOUNT_SUSPENDED） |
| 操作 | Lambda が SendBulkEmail を呼び出す |
| 期待結果 | Lambda がエラー終了し、SQS がリトライする |
| 確認項目 | - Lambda の try-catch でエラーが捕捉されること<br>- SQS メッセージが visibility timeout 後に再出現すること<br>- 3回失敗で DLQ に移動すること |

### C-08: メール送信Lambda — SES ACCOUNT_THROTTLED

| 項目 | 内容 |
|---|---|
| 前提条件 | SES レート上限に達している状況 |
| 操作 | Lambda が SendBulkEmail を呼び出す |
| 期待結果 | ACCOUNT_THROTTLED エラーの宛先が `送信失敗` になるか、SQS リトライで再試行される |
| 確認項目 | - スロットリング発生時の動作が仕様通りであること |

### C-09: メール送信Lambda — SES ACCOUNT_DAILY_QUOTA_EXCEEDED

| 項目 | 内容 |
|---|---|
| 前提条件 | SES 日次送信クォータに達している状況 |
| 操作 | Lambda が SendBulkEmail を呼び出す |
| 期待結果 | ACCOUNT_DAILY_QUOTA_EXCEEDED として処理される |
| 確認項目 | - 該当宛先が `送信失敗` になること<br>- error_message にクォータ超過の内容が記録されること |

### C-10: 送信WF — 完了待ち（State 4 ポーリング）

| 項目 | 内容 |
|---|---|
| 前提条件 | 全メッセージの SQS エンキュー完了。送信処理が進行中 |
| 操作 | State 4 が60秒間隔でポーリング |
| 期待結果 | 未完了件数（`未送信` + `送信中`）= 0 になるまでポーリングが継続される |
| 確認項目 | - ポーリングが60秒間隔で実行されること<br>- 未完了件数のクエリが正しいこと<br>- 残件数 = 0 で State 5 に遷移すること |

### C-11: 送信WF — 最終ステータス更新（State 5）

| 項目 | 内容 |
|---|---|
| 前提条件 | 全宛先の送信処理が完了 |
| 操作 | State 5 が実行される |
| 期待結果 | sent_count, failed_count が集計され、status = `送信完了` に更新される |
| 確認項目 | - sent_count + failed_count = total_count であること<br>- status = `送信完了` であること |

### C-12: DLQ処理 — 正常系

| 項目 | 内容 |
|---|---|
| 前提条件 | メール送信 Lambda が3回失敗し、SQS メッセージが DLQ に移動 |
| 操作 | DLQ処理 Lambda が DLQ メッセージを処理 |
| 期待結果 | メッセージ内の宛先の status が `送信失敗` に更新される |
| 確認項目 | - 宛先 status = `送信失敗` であること<br>- CloudWatch アラームが発火すること |

### C-13: 送信 — SQS メッセージ形式の確認

| 項目 | 内容 |
|---|---|
| 前提条件 | 送信WF の State 3 でエンキュー済み |
| 操作 | SQS メッセージの内容を確認 |
| 期待結果 | メッセージに campaign_id と recipients（最大50件）が含まれる |
| 確認項目 | - campaign_id が正しいこと<br>- recipients 配列が50件以下であること<br>- 各 recipient に id と email が含まれること<br>- メッセージサイズが SQS 上限（256KB）以内であること |

### C-14: 送信 — SES メッセージタグの付与

| 項目 | 内容 |
|---|---|
| 前提条件 | メール送信 Lambda が SES SendBulkEmail を呼び出す |
| 操作 | SES イベントを確認 |
| 期待結果 | SES メッセージタグに campaign_id と recipient_id が付与されている |
| 確認項目 | - mail.tags に campaign_id が含まれること<br>- mail.tags に recipient_id が含まれること |

### C-15: 送信 — Lambda クラッシュ時の宛先ステータス

| 項目 | 内容 |
|---|---|
| 前提条件 | Lambda が status = `送信中` 更新後、SES 呼び出し前にクラッシュ |
| 操作 | Lambda を強制終了させる（タイムアウトを極端に短く設定等） |
| 期待結果 | 宛先 status = `送信中` のまま残る。メールは送信されない |
| 確認項目 | - 重複送信が発生しないこと<br>- `送信中` のまま残った宛先は未送信として扱われること |

### C-16: 送信 — MaxConcurrency 制御の確認

| 項目 | 内容 |
|---|---|
| 前提条件 | SQS に大量メッセージがエンキュー済み |
| 操作 | Event Source Mapping で Lambda が呼び出される |
| 期待結果 | 同時実行 Lambda 数が MaxConcurrency = 4 を超えないこと |
| 確認項目 | - CloudWatch の Lambda 同時実行数メトリクスが4以下であること<br>- SES 送信レートが 200通/秒 を超えないこと |

### C-17: 送信 — SQS visibility timeout の動作確認

| 項目 | 内容 |
|---|---|
| 前提条件 | visibilityTimeout = 120秒 に設定 |
| 操作 | Lambda がメッセージ処理に 120秒以上かかる状況を模擬 |
| 期待結果 | メッセージが再出現し、別の Lambda インスタンスに配信される |
| 確認項目 | - RDS更新先行方式により重複送信が防止されること |

### C-18: 送信 — 少数件（10件）の送信

| 項目 | 内容 |
|---|---|
| 前提条件 | 10件の宛先が登録済み |
| 操作 | 送信WF 全体を実行 |
| 期待結果 | SQS メッセージ1つ（10件）で送信完了。status = `送信完了` |
| 確認項目 | - sent_count = 10, failed_count = 0 であること<br>- 全宛先の status = `送信済` であること |

---

## D. 失敗・リカバリ

### D-01: 一部失敗 — failed_count > 0 での完了判定

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件中1,000件が送信失敗 |
| 操作 | 送信WF の State 5 で集計 |
| 期待結果 | sent_count = 199,000, failed_count = 1,000。ステータスは `一部失敗`（提案5適用の場合）または `送信完了`（現設計） |
| 確認項目 | - sent_count + failed_count = total_count であること<br>- 管理画面で成功数・失敗数が確認できること |

### D-02: 送信失敗リトライAPI — 正常系

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `一部失敗` のキャンペーン（提案5適用時）。1,000件が `送信失敗` |
| 操作 | `POST /campaigns/{id}/retry` |
| 期待結果 | 失敗宛先が SQS に再エンキューされ、リトライが実行される |
| 確認項目 | - status = `リトライ中` に遷移すること<br>- `送信失敗` の1,000件のみが再エンキューされること<br>- `送信済` の宛先には影響がないこと<br>- リトライ後に sent_count, failed_count が再集計されること |

### D-03: 送信失敗リトライ — リトライ回数上限

| 項目 | 内容 |
|---|---|
| 前提条件 | retry_count が上限（例: 3回）に達したキャンペーン |
| 操作 | `POST /campaigns/{id}/retry` |
| 期待結果 | リトライが拒否される |
| 確認項目 | - 適切なエラーメッセージが返却されること |

### D-04: DLQ — maxReceiveCount 動作確認

| 項目 | 内容 |
|---|---|
| 前提条件 | SQS maxReceiveCount = 3 |
| 操作 | Lambda が3回連続でエラー終了する |
| 期待結果 | メッセージが DLQ に移動される |
| 確認項目 | - 3回目の失敗後に DLQ にメッセージが存在すること<br>- 元キューからメッセージが削除されていること |

### D-05: DLQ Lambda — 宛先ステータス更新

| 項目 | 内容 |
|---|---|
| 前提条件 | DLQ に複数メッセージが存在 |
| 操作 | DLQ処理 Lambda が実行される |
| 期待結果 | 各メッセージ内の宛先 status が `送信失敗` に更新される |
| 確認項目 | - 全宛先IDに対して status = `送信失敗` が設定されること<br>- `未送信` → `送信失敗` への遷移が正しいこと |

### D-06: CSV取込WF失敗 — State 0（DELETE）でシステムエラー

| 項目 | 内容 |
|---|---|
| 前提条件 | RDS接続障害を模擬 |
| 操作 | CSV取込WF の State 0 が失敗 |
| 期待結果 | WF が異常終了。status = `取込中` のまま |
| 確認項目 | - 宛先データに部分的な変更が入っていないこと<br>- CloudWatch で検知されること |

### D-07: CSV取込WF失敗 — State 3（FinalizeImport）でシステムエラー

| 項目 | 内容 |
|---|---|
| 前提条件 | State 2 まで成功。State 3 でRDS更新エラー |
| 操作 | CSV取込WF の State 3 が失敗 |
| 期待結果 | status = `取込中` のまま。宛先データは INSERT 済みだがステータスが更新されない |
| 確認項目 | - 運用チームが手動で status を `送信予約済` に更新し、送信WF を起動するリカバリが可能であること |

### D-08: 送信WF失敗 — State 2-3（SQSエンキュー）でエラー

| 項目 | 内容 |
|---|---|
| 前提条件 | SQS サービス障害を模擬 |
| 操作 | 送信WF の State 3 で SQS エンキューが失敗 |
| 期待結果 | WF が異常終了。status = `送信中` または `送信失敗` |
| 確認項目 | - 一部エンキュー済みのメッセージの処理が適切に行われること<br>- CloudWatch アラームが発火すること |

### D-09: 送信WF — State 4 ポーリングのタイムアウト

| 項目 | 内容 |
|---|---|
| 前提条件 | 送信処理が長時間完了しない（例: Lambda が全て失敗しDLQ処理も遅延） |
| 操作 | State 4 のポーリングが長時間継続 |
| 期待結果 | Step Functions の実行タイムアウト（最大1年）に達する前に、CloudWatch で検知される |
| 確認項目 | - ポーリング回数やWF実行時間に上限が設定されていること（設定されていない場合は改善点として記録） |

### D-10: Lambda タイムアウト — メール送信Lambda

| 項目 | 内容 |
|---|---|
| 前提条件 | Lambda のタイムアウトを短く設定（例: 3秒） |
| 操作 | SES SendBulkEmail 実行中にタイムアウト |
| 期待結果 | Lambda がタイムアウトエラーで終了。SQS がリトライ |
| 確認項目 | - RDS更新先行方式により `送信中` マークが残ること<br>- リトライ時にスキップされ重複送信が防止されること |

### D-11: Lambda タイムアウト — CSV分割Lambda

| 項目 | 内容 |
|---|---|
| 前提条件 | 非常に大きなCSVファイル（20万件以上）で Lambda タイムアウト |
| 操作 | CSV分割 Lambda がタイムアウト |
| 期待結果 | Step Functions のリトライが実行される |
| 確認項目 | - Lambda のタイムアウト設定が十分であること（推奨: 15分） |

### D-12: RDS接続エラー — 送信Lambda

| 項目 | 内容 |
|---|---|
| 前提条件 | RDS Proxy が一時的に接続を拒否する状況 |
| 操作 | メール送信 Lambda が RDS 接続を試行 |
| 期待結果 | Lambda がエラー終了。SQS リトライで再試行 |
| 確認項目 | - ConnectionBorrowTimeout（120秒）内に接続が回復した場合は正常処理されること |

### D-13: CloudWatch アラーム — 取込中滞留検知

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `取込中` のキャンペーンが30分以上継続 |
| 操作 | CloudWatch アラームのトリガー |
| 期待結果 | アラームが発火し、運用チームに通知される |
| 確認項目 | - アラーム条件が正しく設定されていること<br>- 通知先（SNS等）に正しく配信されること |

### D-14: CloudWatch アラーム — DLQ メッセージ数閾値

| 項目 | 内容 |
|---|---|
| 前提条件 | DLQ にメッセージが蓄積 |
| 操作 | DLQ メッセージ数が閾値を超過 |
| 期待結果 | CloudWatch アラームが発火する |
| 確認項目 | - アラーム閾値が適切に設定されていること |

---

## E. 複数キャンペーン同時実行

### E-01: 2キャンペーン同時送信 — SESレート制御

| 項目 | 内容 |
|---|---|
| 前提条件 | 2つのキャンペーンが同時に `送信中` 状態。共通SQSキュー使用 |
| 操作 | 両キャンペーンの宛先が共通キューにエンキューされる |
| 期待結果 | MaxConcurrency = 4 により、合計4 Lambda で処理され、SESレート上限（200通/秒）を超えない |
| 確認項目 | - Lambda 同時実行数が4を超えないこと<br>- SES スロットリングが発生しないこと<br>- 両キャンペーンの宛先が正しく送信されること |

### E-02: キャンペーンA送信中にキャンペーンBがエンキュー

| 項目 | 内容 |
|---|---|
| 前提条件 | キャンペーンAの送信が進行中（SQSに大量メッセージあり） |
| 操作 | キャンペーンBの送信WF が Wait 完了し、エンキューを開始 |
| 期待結果 | キャンペーンBのメッセージがキャンペーンAのメッセージに続いてSQSに投入される |
| 確認項目 | - キャンペーンBのメッセージが正しく処理されること<br>- キャンペーンAの完了判定が影響を受けないこと<br>- 各キャンペーンのsent_count/failed_countが独立して正しいこと |

### E-03: 3キャンペーン以上の同時送信

| 項目 | 内容 |
|---|---|
| 前提条件 | 3つのキャンペーンが同時に送信 |
| 操作 | 3キャンペーン分の宛先が共通キューに投入される |
| 期待結果 | MaxConcurrency = 4 の制約下で全キャンペーンが処理される |
| 確認項目 | - SES レート制限を超えないこと<br>- 後続キャンペーンの完了時間が延びることを確認（仕様通り）<br>- 全キャンペーンの最終ステータスが正しいこと |

### E-04: 同時送信時の完了判定の独立性

| 項目 | 内容 |
|---|---|
| 前提条件 | キャンペーンA（1万件）とキャンペーンB（20万件）が同時送信 |
| 操作 | キャンペーンAが先に全件送信完了 |
| 期待結果 | キャンペーンAの State 4 ポーリングがキャンペーンA固有の宛先のみを確認し、`送信完了` に遷移 |
| 確認項目 | - キャンペーンAの完了がキャンペーンBの処理状況に依存しないこと<br>- 各キャンペーンの sent_count が独立して正しいこと |

### E-05: 同時送信時の DLQ 処理

| 項目 | 内容 |
|---|---|
| 前提条件 | 2キャンペーンが同時送信中。一方で DLQ メッセージが発生 |
| 操作 | DLQ Lambda が処理 |
| 期待結果 | DLQ メッセージ内の campaign_id に基づき、正しいキャンペーンの宛先が更新される |
| 確認項目 | - 他キャンペーンの宛先に影響がないこと |

### E-06: CSV取込WFと送信WFの同時実行

| 項目 | 内容 |
|---|---|
| 前提条件 | キャンペーンAが送信中。キャンペーンBのCSV取込が進行中 |
| 操作 | 両WFが同時に RDS にアクセス |
| 期待結果 | RDS Proxy により接続が適切に管理され、両WFが正常に動作する |
| 確認項目 | - RDS 接続数が上限を超えないこと（最大12程度）<br>- 各WFが互いにブロックしないこと |

---

## F. バウンス・苦情処理

### F-01: Hard Bounce 検知 → suppression_list 登録

| 項目 | 内容 |
|---|---|
| 前提条件 | メール送信完了後、SES から Bounce イベント（bounceType = Permanent）が発生 |
| 操作 | Bounce Aggregator Lambda（定期バッチ）が実行される |
| 期待結果 | 該当宛先の status = `バウンス`、suppression_list に登録される |
| 確認項目 | - notification_recipients.status = `バウンス`<br>- bounce_type = `Permanent`<br>- bounce_sub_type, diagnostic_code, bounce_at が記録されること<br>- suppression_list に reason = `hard_bounce` で登録されること |

### F-02: Soft Bounce 検知 → 累計カウント確認

| 項目 | 内容 |
|---|---|
| 前提条件 | 同一メールアドレスに対して Soft Bounce が2回発生（閾値3回未満） |
| 操作 | Bounce Aggregator Lambda が実行される |
| 期待結果 | status = `バウンス` に更新されるが、suppression_list には未登録 |
| 確認項目 | - notification_recipients.status = `バウンス`<br>- bounce_type = `Transient`<br>- suppression_list に登録されていないこと |

### F-03: Soft Bounce 閾値超過 → suppression_list 登録

| 項目 | 内容 |
|---|---|
| 前提条件 | 同一メールアドレスに対して Soft Bounce が累計3回（閾値）発生 |
| 操作 | Bounce Aggregator Lambda が実行される |
| 期待結果 | suppression_list に登録される |
| 確認項目 | - suppression_list に reason = `soft_bounce_limit` で登録されること<br>- メールアドレス単位のキャンペーン横断集計が正しいこと |

### F-04: 苦情（Complaint）検知 → suppression_list 登録

| 項目 | 内容 |
|---|---|
| 前提条件 | 受信者がスパム報告。SES から Complaint イベントが発生 |
| 操作 | Bounce Aggregator Lambda が実行される |
| 期待結果 | 宛先 status = `苦情`、suppression_list に登録される |
| 確認項目 | - notification_recipients.status = `苦情`<br>- complaint_type, complaint_at が記録されること<br>- suppression_list に reason = `complaint` で登録されること |

### F-05: suppression_list のCSV取込時突合

| 項目 | 内容 |
|---|---|
| 前提条件 | suppression_list に `test@example.com` が登録済み。新CSVにこのアドレスが含まれる |
| 操作 | 新キャンペーンの CSV取込WF を実行 |
| 期待結果 | `test@example.com` が除外され、notification_recipients に INSERT されない |
| 確認項目 | - total_count が suppression 除外後の件数であること<br>- 除外件数がログに記録されること |

### F-06: suppression_list 重複登録防止

| 項目 | 内容 |
|---|---|
| 前提条件 | suppression_list に既に登録済みのアドレスに対して再度 Hard Bounce が発生 |
| 操作 | Bounce Aggregator Lambda が実行される |
| 期待結果 | UNIQUE制約により重複登録が防止される。エラーにはならない |
| 確認項目 | - INSERT ON CONFLICT（またはINSERT IGNORE）で処理されること<br>- 既存レコードが上書きされないこと |

### F-07: SES イベントパイプライン — Kinesis Data Firehose → S3

| 項目 | 内容 |
|---|---|
| 前提条件 | SES Configuration Set にイベント送信先が設定済み |
| 操作 | メール送信後、SES イベントが発生 |
| 期待結果 | イベントが Kinesis Data Firehose 経由で S3 に蓄積される |
| 確認項目 | - S3 パス: `ses-events/year=YYYY/month=MM/day=DD/` にファイルが存在すること<br>- Send, Delivery, Bounce, Complaint, Open, Click イベントが含まれること |

### F-08: Athena によるイベントクエリ

| 項目 | 内容 |
|---|---|
| 前提条件 | F-07 で S3 にイベントが蓄積済み |
| 操作 | Athena でクエリを実行 |
| 期待結果 | キャンペーン別の送信数・バウンス数・開封数等が集計できる |
| 確認項目 | - Athena テーブル定義が正しいこと<br>- パーティション（year/month/day）が機能していること |

### F-09: SES メッセージタグによる宛先特定

| 項目 | 内容 |
|---|---|
| 前提条件 | SES イベント JSON に mail.tags（campaign_id, recipient_id）が含まれている |
| 操作 | Bounce Aggregator Lambda がイベントを処理 |
| 期待結果 | mail.tags の campaign_id, recipient_id で notification_recipients を直接特定できる |
| 確認項目 | - タグベースの特定が正しく動作すること |

### F-10: ses_message_id フォールバック

| 項目 | 内容 |
|---|---|
| 前提条件 | SES イベントで mail.tags が取得できないケース |
| 操作 | Bounce Aggregator Lambda がフォールバック処理を実行 |
| 期待結果 | ses_message_id による逆引きで notification_recipients を特定できる |
| 確認項目 | - idx_recipients_ses_message_id インデックスが使用されること<br>- 正しい宛先レコードが更新されること |

---

## G. CSVバリデーション

### G-01: 正常なCSV — UTF-8、ヘッダーあり

| 項目 | 内容 |
|---|---|
| 前提条件 | UTF-8 エンコーディング、email ヘッダーあり、全行が正常なメールアドレス |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 全件が正常に取り込まれる |
| 確認項目 | - total_count が CSV 行数（ヘッダー除く）と一致すること |

### G-02: エンコーディングエラー — Shift_JIS

| 項目 | 内容 |
|---|---|
| 前提条件 | Shift_JIS エンコーディングの CSV |
| 操作 | CSV取込WF 実行 |
| 期待結果 | CSVValidationError が throw される |
| 確認項目 | - status = `取込失敗` に更新されること<br>- エラーメッセージにエンコーディングエラーの旨が含まれること |

### G-03: ヘッダー行なし

| 項目 | 内容 |
|---|---|
| 前提条件 | ヘッダー行がない（または email カラムが存在しない）CSV |
| 操作 | CSV取込WF 実行 |
| 期待結果 | CSVValidationError が throw される |
| 確認項目 | - status = `取込失敗` に更新されること |

### G-04: メールアドレス形式不正 — @なし

| 項目 | 内容 |
|---|---|
| 前提条件 | CSVに `@` を含まない文字列（例: `invalid-email`）が混在 |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 不正行がスキップされ、正常行のみが取り込まれる（または全件エラーとする仕様による） |
| 確認項目 | - スキップされた行がログに記録されること<br>- total_count がバリデーション通過件数であること |

### G-05: 重複メールアドレスの排除

| 項目 | 内容 |
|---|---|
| 前提条件 | CSV に同一メールアドレスが3行含まれる |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 重複が排除され、1件として取り込まれる |
| 確認項目 | - notification_recipients に重複レコードがないこと<br>- total_count が重複排除後の件数であること |

### G-06: 空行・不正行の処理

| 項目 | 内容 |
|---|---|
| 前提条件 | CSVに空行や不正な行（カラム数不一致等）が混在 |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 空行・不正行がスキップされ、正常行のみ取り込まれる |
| 確認項目 | - スキップ件数がログに記録されること |

### G-07: 空のCSVファイル（ヘッダーのみ）

| 項目 | 内容 |
|---|---|
| 前提条件 | ヘッダー行のみで宛先が0件の CSV |
| 操作 | CSV取込WF 実行 |
| 期待結果 | バリデーションエラーまたは total_count = 0 で正常完了（仕様による） |
| 確認項目 | - 0件で送信予約が作成される場合、送信WF が適切に処理されること |

### G-08: 非常に大きなCSVファイル（20万件超）

| 項目 | 内容 |
|---|---|
| 前提条件 | 30万件のメールアドレスを含むCSV |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 20万件上限の制約がある場合はバリデーションエラー。上限がなければ正常処理される |
| 確認項目 | - 件数上限バリデーションの有無と動作を確認<br>- チャンク数が正しく計算されること（30万件なら60チャンク） |

### G-09: CSVファイルサイズが非常に大きい場合

| 項目 | 内容 |
|---|---|
| 前提条件 | メールアドレスが長い（最大254文字）の20万件CSV（約50MB超） |
| 操作 | Presigned URL でアップロード → CSV取込WF 実行 |
| 期待結果 | S3 への直接アップロードのため、サイズ制限に引っかからず処理される |
| 確認項目 | - アップロードが成功すること<br>- CSV分割 Lambda がメモリ不足にならないこと |

### G-10: suppression_list との突合 — 大量除外

| 項目 | 内容 |
|---|---|
| 前提条件 | suppression_list に5万件登録済み。CSVの20万件中2万件が suppression 対象 |
| 操作 | CSV取込WF 実行 |
| 期待結果 | 2万件が除外され、18万件が取り込まれる |
| 確認項目 | - total_count = 180,000 であること<br>- 除外件数（20,000）がログまたは管理画面で確認できること<br>- suppression_list との突合がパフォーマンスに問題ないこと |

---

## H. 排他制御

### H-01: 楽観的ロック — 同時編集の競合検出

| 項目 | 内容 |
|---|---|
| 前提条件 | スタッフAとスタッフBが同じキャンペーンを取得（version = 1） |
| 操作 | スタッフAが先にPUT（version=1で成功） → スタッフBがPUT（version=1で競合） |
| 期待結果 | スタッフAは成功（200）。スタッフBは HTTP 409 Conflict |
| 確認項目 | - スタッフAの更新が反映されていること（version = 2）<br>- スタッフBの更新は反映されていないこと<br>- フロントエンドで「他のスタッフが編集しました」メッセージが表示されること |

### H-02: 楽観的ロック — バージョン不一致時のリトライ

| 項目 | 内容 |
|---|---|
| 前提条件 | H-01 でスタッフBが 409 を受けた後 |
| 操作 | スタッフBが最新データを取得（version = 2）→ 再度 PUT（version = 2） |
| 期待結果 | 更新成功（200）。version = 3 に更新される |
| 確認項目 | - リトライフローが正常に動作すること |

### H-03: ステータス排他 — 取込中に編集リクエスト

| 項目 | 内容 |
|---|---|
| 前提条件 | CSV取込WF が実行中（status = `取込中`） |
| 操作 | `PUT /campaigns/{id}` を呼び出す |
| 期待結果 | HTTP 409 Conflict |
| 確認項目 | - CSV取込WF の処理が中断されないこと<br>- フロントエンドで編集ボタンが非活性であること |

### H-04: ステータス排他 — 送信中に編集リクエスト

| 項目 | 内容 |
|---|---|
| 前提条件 | 送信WF が実行中（status = `送信中`） |
| 操作 | `PUT /campaigns/{id}` を呼び出す |
| 期待結果 | HTTP 409 Conflict |
| 確認項目 | - 送信処理が中断されないこと |

### H-05: Step Functions 重複起動防止

| 項目 | 内容 |
|---|---|
| 前提条件 | CSV取込WF が実行中 |
| 操作 | 同じ campaign_id で再度 startExecution を呼び出す |
| 期待結果 | execution name の冪等性により重複起動が防止される |
| 確認項目 | - 2つの WF が同時実行されないこと<br>- 適切なエラーレスポンスが返ること |

### H-06: 編集API — ステータス確認→更新のアトミック性

| 項目 | 内容 |
|---|---|
| 前提条件 | status = `送信予約済` のキャンペーン |
| 操作 | 編集APIのステータス確認とステータス更新の間に、送信WFが status を `送信中` に変更する |
| 期待結果 | レースコンディションが発生しないこと |
| 確認項目 | - ステータス確認→更新がトランザクション内で実行されること（SELECT FOR UPDATE 等）<br>- 送信WFの更新と競合した場合に適切にエラーハンドリングされること |

---

## I. パフォーマンス・負荷

### I-01: CSV取込 — 20万件の処理時間

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件のメールアドレスCSV |
| 操作 | CSV取込WF を実行 |
| 期待結果 | 約24〜33秒以内に完了 |
| 確認項目 | - State 0（DELETE）: 約2-5秒<br>- State 1（CSV分割）: 約5-10秒<br>- State 2（Map State INSERT）: 約16秒（8ラウンド × 約2秒）<br>- State 3（ステータス更新）: 約1-2秒<br>- 合計が設計見積もり以内であること |

### I-02: メール送信 — 20万件のスループット

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件の宛先。SES送信レート 200通/秒。MaxConcurrency = 4 |
| 操作 | 送信WF を実行 |
| 期待結果 | 約17分（1,000秒）で全件送信完了 |
| 確認項目 | - 実際の送信レートが約200通/秒であること<br>- 送信完了までの時間が見積もり範囲内であること |

### I-03: RDS接続数 — 最大同時接続のモニタリング

| 項目 | 内容 |
|---|---|
| 前提条件 | CSV取込WF（Map State 5並列）とメール送信（4並列）が同時に実行 |
| 操作 | CloudWatch で RDS Proxy メトリクスを監視 |
| 期待結果 | DatabaseConnections が max_connections の 80% を超えないこと |
| 確認項目 | - ClientConnections の最大値（約12程度）を記録<br>- DatabaseConnections の最大値を記録<br>- ピン留め（SessionPinned）が発生していないこと |

### I-04: RDS Proxy — 接続プール性能

| 項目 | 内容 |
|---|---|
| 前提条件 | メール送信フローで4 Lambda が同時にRDSアクセス |
| 操作 | 20万件送信（4,000回のLambda実行）を通じてRDS Proxyの動作を確認 |
| 期待結果 | 接続プールが正常に機能し、接続確立オーバーヘッドが削減される |
| 確認項目 | - Lambda のコールドスタートによる接続急増がないこと<br>- ConnectionBorrowTimeout 内に接続が取得できること |

### I-05: SQS — 大量メッセージのエンキュー性能

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件 / 50 = 4,000 SQS メッセージ |
| 操作 | Map State で並列エンキュー |
| 期待結果 | エンキューがボトルネックにならず、数分以内に完了すること |
| 確認項目 | - SQS メッセージ数が4,000であること<br>- エンキュー完了までの時間を記録 |

### I-06: 段階的負荷テスト — 100件 → 1,000件 → 10,000件 → 200,000件

| 項目 | 内容 |
|---|---|
| 前提条件 | 各段階でCSVを準備 |
| 操作 | 段階的にスケールアップしながら全フロー（登録→CSV取込→送信）を実行 |
| 期待結果 | 各段階で正常動作し、パフォーマンスが線形にスケールすること |
| 確認項目 | **100件**: 基本動作確認<br>**1,000件**: バッチ処理の動作確認（チャンク数 = 1）<br>**10,000件**: Map State 並列処理の動作確認（チャンク数 = 2）<br>**200,000件**: 本番相当のフルテスト（チャンク数 = 40） |

### I-07: Lambda メモリ使用量の確認

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件の全フロー実行 |
| 操作 | CloudWatch Logs から各 Lambda のメモリ使用量を確認 |
| 期待結果 | メモリ使用量が割り当てメモリの80%を超えないこと |
| 確認項目 | - CSV分割 Lambda（大きなCSVを読み込む）のメモリ使用量<br>- バッチINSERT Lambda のメモリ使用量<br>- メール送信 Lambda のメモリ使用量 |

### I-08: RDS CPU・メモリ使用率の確認

| 項目 | 内容 |
|---|---|
| 前提条件 | 20万件の全フロー実行（CSV取込 + 送信） |
| 操作 | CloudWatch で RDS メトリクスを監視 |
| 期待結果 | CPU使用率が80%を超えないこと。メモリ使用率が安定していること |
| 確認項目 | - CPU使用率のピーク値<br>- FreeableMemory の最小値<br>- WriteIOPS / ReadIOPS のピーク値<br>- db.t3.medium のスペックで十分か確認 |

---

## 補足: テスト環境の考慮事項

### SES サンドボックスモードでの制約

| 制約 | 対応 |
|---|---|
| 送信先は検証済みアドレスのみ | テスト用に検証済みアドレスを複数登録（SES の Email Simulator アドレスを活用） |
| 送信レート 1通/秒 | 少数件テストはサンドボックスで実施。負荷テストはプロダクションアクセス取得後 |
| 日次送信数 200通 | 段階1（100件）まではサンドボックスで可能 |

### SES Email Simulator アドレス

| アドレス | 用途 |
|---|---|
| `success@simulator.amazonses.com` | 正常送信のテスト |
| `bounce@simulator.amazonses.com` | バウンスのテスト |
| `complaint@simulator.amazonses.com` | 苦情のテスト |
| `suppressionlist@simulator.amazonses.com` | SES 抑制リスト登録のテスト |
| `ooto@simulator.amazonses.com` | 自動応答のテスト |

### テストデータ

| データ | 内容 |
|---|---|
| 正常CSV | 各段階の件数（100/1,000/10,000/200,000）で準備 |
| 不正CSV | エンコーディングエラー、ヘッダーなし、形式不正の各パターン |
| 混在CSV | 正常行と不正行が混在（バリデーション動作確認用） |
| suppression対象CSV | suppression_list に登録済みアドレスを含むCSV |
