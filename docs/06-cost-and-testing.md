# コスト概算・検証方法

## コスト概算（1回の送信あたり、20万件）

| サービス | 概算コスト | 備考 |
|---|---|---|
| SES (200,000通) | ~$20 | $0.10/1,000通 |
| Lambda | ~$2-3 | CSV取込 + 送信処理の合計 |
| SQS | ~$0.20 | メール送信キュー |
| Step Functions | ~$0.05 | CSV取込 + 送信ワークフロー |
| S3 | ~$0.01 | CSVファイル + チャンクファイル |
| RDS | - | インスタンス稼働費用は別途（常時起動） |
| RDS Proxy | - | vCPU単位の時間課金（常時起動） |
| **合計（RDS除く）** | **~$23/回** | |

### 月額固定費の目安

| サービス | 月額概算 | 備考 |
|---|---|---|
| RDS (db.t3.medium) | ~$50-70 | オンデマンド、東京リージョン |
| RDS Proxy (2 vCPU) | ~$20-30 | db.t3.medium の vCPU 数に基づく |
| **月額固定費 合計** | **~$70-100** | |

---

## 検証方法

### 1. 単体テスト

各 Lambda のユニットテスト:
- Presigned URL 発行 Lambda
- キャンペーン登録 Lambda
- CSV分割 Lambda
- 宛先バッチINSERT Lambda
- メール送信 Lambda
- DLQ処理 Lambda

### 2. 結合テスト

SES サンドボックスモードで少数件（10件程度）の送信テスト:
- 登録フロー全体（Presigned URL → CSV アップロード → API → CSV取込WF → 送信WF自動起動）
- 編集フロー（パターンA: メタデータ編集、パターンB: CSV差し替え）
- 送信フロー（Step Functions Wait → SQS → Lambda → SES）
- 失敗フロー（DLQ → ステータス更新）

### 3. 負荷テスト

段階的にスケールアップ:

| 段階 | 件数 | 確認項目 |
|---|---|---|
| 1 | 100件 | 基本動作確認 |
| 2 | 1,000件 | バッチ処理の動作確認 |
| 3 | 10,000件 | Map State 並列処理の動作確認 |
| 4 | 200,000件 | 本番相当のフルテスト |

### 4. 監視確認

CloudWatch メトリクス・アラームが正常動作するか確認:
- Lambda エラー率
- SQS メッセージ滞留数
- DLQ メッセージ数
- Step Functions 実行ステータス
- RDS 接続数・CPU使用率

### 5. DLQ テスト

意図的にエラーを発生させ、DLQ 処理が正しく動くか確認:
- SES に無効なメールアドレスを送信
- Lambda タイムアウトを短く設定して強制失敗
- DLQ → Lambda → RDS ステータス更新の確認
